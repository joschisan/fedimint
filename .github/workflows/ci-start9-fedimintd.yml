name: "Build Start9 fedimintd Package"

# Runs after CI (nix) completes, which publishes the fedimint/fedimintd
# Docker Hub image that the s9pk Dockerfile depends on
on:
  workflow_run:
    workflows: ["CI (nix)"]
    types: [completed]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-fedimintd-s9pk:
    name: "Build fedimintd.s9pk"
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      startsWith(github.event.workflow_run.head_branch, 'v')
    runs-on: ubuntu-24.04
    timeout-minutes: 180
    env:
      IS_PRERELEASE: ${{
          contains(github.event.workflow_run.head_branch, 'beta') ||
          contains(github.event.workflow_run.head_branch, 'rc')
        }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install system dependencies
        run: |
          sudo rm /etc/apt/sources.list.d/microsoft-prod.list
          sudo apt-get update
          sudo apt-get install -y git build-essential openssl libssl-dev libc6-dev clang libclang-dev ca-certificates curl
      - name: Install yq
        run: |
          curl -sS https://webi.sh/yq | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Install deno
        run: |
          curl -fsSL https://deno.land/install.sh | sh
          echo "$HOME/.deno/bin" >> $GITHUB_PATH
      # start-os v0.3.5.1 doesn't compile on newer Rust versions
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.85.1"
      - name: Install cargo tools
        run: |
          # web-static-pack-packer 0.5.2 requires rustc 1.88+
          cargo install --force --locked toml-cli "web-static-pack-packer@0.5.0"
          cargo install --git=https://github.com/Start9Labs/md-packer.git --branch=main
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Checkout start-os SDK
        uses: actions/checkout@v4
        with:
          repository: Start9Labs/start-os
          ref: v0.3.5.1
          submodules: recursive
      - name: Cache start-sdk
        uses: actions/cache@v4
        id: cache
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-${{ runner.arch }}-start-sdk-${{ hashFiles('**/install-sdk.sh') }}
      - name: Build start-sdk
        run: |
          if [ -z "$(command -v start-sdk)" ]; then
            export RUSTFLAGS=""
            export OS_ARCH=$(uname -m)
            mkdir -p web/dist/static
            ./check-git-hash.sh
            cargo update -p time --manifest-path=core/Cargo.toml
            cd core && ./install-sdk.sh
            echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          fi
      - name: Checkout fedimint
        uses: actions/checkout@v4
      - name: Build s9pk
        id: build
        working-directory: fedimint-startos
        run: |
          start-sdk init
          make
          VERSION=$(yq -oy '.version' manifest.yaml)
          mv fedimintd.s9pk "fedimintd-v${VERSION}.s9pk"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
      - name: Upload s9pk
        uses: actions/upload-artifact@v6
        with:
          name: fedimintd-v${{ steps.build.outputs.version }}.s9pk
          path: fedimint-startos/fedimintd-v*.s9pk
      - name: Attach to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.workflow_run.head_branch }}
          files: fedimint-startos/fedimintd-v*.s9pk
          prerelease: ${{ env.IS_PRERELEASE }}
